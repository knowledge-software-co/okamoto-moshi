# 🐛 ブラウザテスト失敗時のデバッグ方法（Laravel Dusk） - How to Debug (browser)

### `Laravel Dusk` の実行時の注意事項

テスト実行中に、手動で強制終了することは避けてください。

理由：

- テスト実行中は一時的なテスト用 .env ファイルが生成されます。
- 強制終了すると、この一時ファイルが不完全な状態で残る可能性があります。
- 結果として、以降のテストや操作が誤った環境設定で実行される危険性があります。

## エラー出力時の確認箇所

- ターミナル（コマンドプロンプト）のログを確認
- `/tests/Browser/screenshots` ディレクトリにスクリーンショットが保存されているかを確認
- `/tests/Browser/console` ディレクトリにログが保存されているかを確認

## デバッグ方法

まずは、スクリーンショットやログを確認して対応してください。

### タイムアウトエラーの場合

以下の条件の時

- ターミナル（コマンドプロンプト）でタイムアウトエラー
- スクリーンショット出力なし
- `/tests/Browser/console` ディレクトリのログでVueファイルのエラーが出ている

対応方法

1. `$ ./vendor/bin/sail npm run dev` を実行し、どのページでも良いのでブラウザで表示できることを確認する
1. 表示されることを確認したら、Duskを実行

上記実行することでエラーが解消されることがあります。

### `Laravel Dusk` 実行時に詳細情報を確認したい時

より詳細な情報が必要な場合は、以下のデバッグオプションを使用してください：

```bash
$ ./vendor/bin/sail dusk --debug
```

このコマンドを実行した場合、

- テストの実行過程が詳細に表示されます。
- エラーが発生した箇所の具体的な情報が提供されます。
- スタックトレースなど、問題解決に役立つ追加情報が表示されます。

デバッグ出力を注意深く確認し、エラーの原因を特定してください。

### 解決できない場合

下記をお試しください

1. `$ ./vendor/bin/sail down` を実行し、dockerコンテナを停止
1. Docker Desktopアプリケーションを停止
1. PCを再起動
1. もう一度Duskを実行

or

1. `$ task remake-production` で本番環境を再構築

### うまく動かない場合のチェック項目

- [ ] `public/hot` は存在しますか？存在したらHRMが有効になっているので、`./vendor/bin/sail npm run dev` を終了（`ctrl + c`）してください。
- [ ] ブラウザで `.env.dusk.local` の `APP_URL` にアクセスして、ページが表示されるか確認してください。
- [ ] `.env.dusk.local` の `APP_URL` と `NGROK_AUTHTOKEN` と `NGROK_DOMAIN` は正しい値か確認してください。
- [ ] `.env.dusk.local` の修正前のキャッシュが残っている可能性があるため、`./vendor/bin/sail artisan config:clear` を実行してください。
- [ ] ngrokの転送量の上限に達していないか確認してください。
